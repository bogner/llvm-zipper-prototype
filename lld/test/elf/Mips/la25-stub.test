# REQUIRES: mips

# Check LA25 stubs creation when PIC code is called from non-PIC routines.

# Build executable from pic and non-pic code.
# RUN: yaml2obj -format=elf %S/Inputs/npic-obj.yaml > %t-npic-o
# RUN: yaml2obj -format=elf %S/Inputs/pic-obj.yaml > %t-pic-o
# RUN: llvm-mc -triple=mipsel -filetype=obj -o=%t-main-o %s
# RUN: lld -flavor gnu -target mipsel -e glob -o %t-exe \
# RUN:         %t-npic-o %t-pic-o %t-main-o
#
# RUN: llvm-objdump -disassemble %t-exe | FileCheck -check-prefix=EXE %s

# EXE: Disassembly of section .text:
# EXE: T1N:
# EXE-NEXT:   400140:       00 00 00 00  nop

# EXE: T1:
# EXE-NEXT:   400150:       00 00 00 00  nop

# EXE: glob:
# EXE-NEXT:   40015c:       09 f8 20 03  jalr    $25
# EXE-NEXT:   400160:       00 00 00 00  nop

# Jump to 'loc' label address
# EXE-NEXT:   400164:       5b 00 10 0c  jal     4194668
# EXE-NEXT:   400168:       00 00 00 00  nop
#
# EXE: loc:
# Jump to 'glob' non-pic symbol
# EXE-NEXT:   40016c:       57 00 10 0c  jal     4194652
# EXE-NEXT:   400170:       00 00 00 00  nop
# Jump to 'T1N' non-pic symbol
# EXE-NEXT:   400174:       50 00 10 0c  jal     4194624
# EXE-NEXT:   400178:       00 00 00 00  nop
# Jump to LA25 stub for 'T1' pic symbol
# EXE-NEXT:   40017c:       64 00 10 0c  jal     4194704
# EXE-NEXT:   400180:       00 00 00 00  nop
# EXE-NEXT:   400184:       00 00 00 00  nop
# EXE-NEXT:   400188:       00 00 00 00  nop
# EXE-NEXT:   40018c:       00 00 00 00  nop

# LA25 Stub
# EXE-NEXT:   400190:       40 00 19 3c  lui     $25, 64
# Jump to 'T1' label address
# EXE-NEXT:   400194:       54 00 10 08  j       4194640
# EXE-NEXT:   400198:       50 01 39 27  addiu   $25, $25, 336
# EXE-NEXT:   40019c:       00 00 00 00  nop

    .global glob
    .ent    glob
glob:
    jal     $t9
    jal     loc
loc:
    jal     glob
    jal     T1N
    jal     T1
    .end    glob
